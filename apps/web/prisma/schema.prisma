// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id String @id @default(cuid())

  clerkId String @unique

  familyId String?

  admin Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Family {
  id String @id @default(cuid())

  name String

  primaryContactName String?
  primaryEmail       String?
  primaryPhone       String?

  secondaryContactName String?
  secondaryEmail       String?
  secondaryPhone       String?

  medicalContactName  String?
  medicalContactPhone String?

  students Student[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Student {
  id String @id @default(cuid())

  name         String
  dateOfBirth  DateTime
  medicalNotes String?

  family   Family @relation(fields: [familyId], references: [id])
  familyId String

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  enrolments      Enrolment[]
  attendances     Attendance[]
  waitlistEntries WaitlistEntry[]
}

model ClassTemplate {
  id String @id @default(cuid())

  name      String?
  dayOfWeek Int? //0-6 for Mon to Sun
  startTime Int? //Modelled as minutes since midnight
  endTime   Int? //Modelled as minutes since midnight

  capacity Int?
  active   Boolean @default(true)

  levelId String
  level   Level  @relation(fields: [levelId], references: [id])

  instances ClassInstance[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  enrolments      Enrolment[]
  waitlistEntries WaitlistEntry[]
}

model ClassInstance {
  id String @id @default(cuid())

  templateId String?
  template   ClassTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  startTime DateTime
  endTime   DateTime

  status   String?
  capacity Int?

  levelId String
  level   Level  @relation(fields: [levelId], references: [id])

  enrolments Enrolment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enrolmentLinks        EnrolmentOnClassInstance[]
  attendances           Attendance[]
  enrolmentReservations EnrolmentReservation[]

  @@unique([templateId, startTime])
}

enum EnrolmentStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

model Enrolment {
  id String @id @default(cuid())

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  templateId String
  template   ClassTemplate @relation(fields: [templateId], references: [id])

  startDate   DateTime
  endDate     DateTime?
  status      EnrolmentStatus @default(ACTIVE)
  cancelledAt DateTime?

  planId String?
  plan   EnrolmentPlan? @relation(fields: [planId], references: [id])

  reservations EnrolmentReservation[]
  purchases    EnrolmentPurchase[]
  pauses       EnrolmentPause[]

  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  classInstance             ClassInstance?             @relation(fields: [classInstanceId], references: [id])
  classInstanceId           String?
  enrolmentOnClassInstances EnrolmentOnClassInstance[]

  @@index([studentId])
  @@index([templateId])
}

model EnrolmentReservation {
  id String @id @default(cuid())

  enrolmentId String
  enrolment   Enrolment @relation(fields: [enrolmentId], references: [id], onDelete: Cascade)

  classId String
  class   ClassInstance @relation(fields: [classId], references: [id], onDelete: Cascade)

  studentId String // denormalized for constraints + fast roster queries

  status      ReservationStatus @default(HELD) // see below
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classId, studentId]) // prevents double booking a student in the same class instance
  @@unique([enrolmentId, classId])
  @@index([classId])
  @@index([studentId])
}

enum ReservationStatus {
  HELD
  RELEASED
}

enum PurchaseStatus {
  ACTIVE
  FULLY_USED
  REFUNDED
}

model EnrolmentPurchase {
  id String @id @default(cuid())

  enrolmentId String
  enrolment   Enrolment @relation(fields: [enrolmentId], references: [id], onDelete: Cascade)

  // What was purchased
  sessionsPurchased Int
  priceCents        Int // total paid upfront

  // Consumption tracking
  sessionsConsumed Int @default(0)

  // Refund tracking
  refundedCents Int            @default(0)
  status        PurchaseStatus @default(ACTIVE)

  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([enrolmentId])
}

model EnrolmentPause {
  id String @id @default(cuid())

  enrolmentId String
  enrolment   Enrolment @relation(fields: [enrolmentId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime?

  holdSeat Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([enrolmentId])
}

enum WaitlistStatus {
  WAITING
  OFFERED
  ENROLLED
  CANCELLED
}

model WaitlistEntry {
  id String @id @default(cuid())

  templateId String
  template   ClassTemplate @relation(fields: [templateId], references: [id])

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  desiredStartDate DateTime?
  status           WaitlistStatus @default(WAITING)

  priority Int @default(0) // optional: staff overrides / medical priority etc.

  offeredAt DateTime?
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, studentId, status]) // prevents duplicate waiting entries
  @@index([templateId, status, priority, createdAt])
}

enum PaymentProvider {
  CASH
  CARD
  STRIPE
  OTHER
}

model Payment {
  id String @id @default(cuid())

  provider    PaymentProvider
  amountCents Int

  // optional linkage
  familyId            String?
  enrolmentPurchaseId String?

  providerRef        String?
  createdAt          DateTime            @default(now())
  enrolmentPurchases EnrolmentPurchase[]
}

enum EnrolmentType {
  BLOCK
  CLASS
}

enum BillingType {
  PER_WEEK
  PER_CLASS
}

model EnrolmentPlan {
  id String @id @default(cuid())

  name       String
  priceCents Int    @default(0)

  enrolmentType EnrolmentType @default(BLOCK)
  billingType   BillingType   @default(PER_CLASS)

  levelId String
  level   Level  @relation(fields: [levelId], references: [id])

  blockLength Int @default(1)

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  enrolments Enrolment[]
}

model EnrolmentOnClassInstance {
  id String @id @default(cuid())

  enrolmentId String
  studentId   String
  classId     String

  enrolment Enrolment     @relation(fields: [enrolmentId], references: [id])
  class     ClassInstance @relation(fields: [classId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classId, studentId]) // prevents double booking
  @@index([studentId])
  @@index([classId])
}

model Level {
  id String @id @default(cuid())

  name             String
  levelOrder       Int    @default(0)
  defaultLengthMin Int    @default(30)
  defaultCapacity  Int?

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  classTemplates ClassTemplate[]
  classInstances ClassInstance[]
  enrolmentPlans EnrolmentPlan[]
}

model Makeup {
  id String @id @default(cuid())

  originalClassId String?
  newClassId      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Teacher {
  id String @id @default(cuid())

  name     String
  position String?
  phone    String?
  email    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  MAKEUP
  EXCUSED
}

model Attendance {
  id String @id @default(cuid())

  classId String
  class   ClassInstance @relation(fields: [classId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  status AttendanceStatus
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classId, studentId])
  @@index([studentId])
}
