// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id String @id @default(cuid())

  clerkId String @unique

  familyId String?

  admin Boolean @default(false)

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  classCancellations   ClassCancellation[]
  enrolmentAdjustments EnrolmentAdjustment[]
  timesheetEntries     TeacherTimesheetEntry[]     @relation("TimesheetEntryCreator")
  timesheetAdjustments TeacherTimesheetAdjustment[] @relation("TimesheetAdjustmentCreator")
  teacherPayRates      TeacherPayRate[]            @relation("TeacherPayRateCreator")
  payRuns              PayRun[]                    @relation("PayRunCreator")
  payrollAdjustments   PayrollAdjustment[]         @relation("PayrollAdjustmentCreator")
}

model Family {
  id String @id @default(cuid())

  name String

  primaryContactName String?
  primaryEmail       String?
  primaryPhone       String?

  secondaryContactName String?
  secondaryEmail       String?
  secondaryPhone       String?

  medicalContactName  String?
  medicalContactPhone String?

  students Student[]
  invoices Invoice[]

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  payments      Payment[]
  conversations Conversation[]
  messages      Message[]
}

model Student {
  id String @id @default(cuid())

  name         String
  dateOfBirth  DateTime
  medicalNotes String?

  family   Family @relation(fields: [familyId], references: [id])
  familyId String

  level   Level?  @relation(fields: [levelId], references: [id])
  levelId String?

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  enrolments       Enrolment[]
  attendances      Attendance[]
  invoiceLineItems InvoiceLineItem[]
}

model ClassTemplate {
  id String @id @default(cuid())

  name      String?
  dayOfWeek Int? //0-6 for Mon to Sun
  startTime Int? //Modelled as minutes since midnight
  endTime   Int? //Modelled as minutes since midnight

  startDate DateTime  @default(now())
  endDate   DateTime?

  capacity Int?
  active   Boolean @default(true)

  levelId String
  level   Level  @relation(fields: [levelId], references: [id])

  teacherId String?
  teacher   Teacher? @relation("ClassTemplateTeacher", fields: [teacherId], references: [id])

  timesheetEntries     TeacherTimesheetEntry[]

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  enrolments           Enrolment[]
  teacherSubstitutions TeacherSubstitution[]
  attendances          Attendance[]
  cancellations        ClassCancellation[]
  enrolmentAdjustments EnrolmentAdjustment[]
}

model TeacherSubstitution {
  id String @id @default(cuid())

  templateId String
  template   ClassTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // occurrence date (normalize to local midnight)
  date DateTime

  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id])

  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, date])
  @@index([date])
  @@index([templateId, date])
}

model TeacherTimesheetEntry {
  id String @id @default(cuid())

  templateId String
  template   ClassTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  date DateTime

  teacherId String?
  teacher   Teacher? @relation("TeacherTimesheetEntries", fields: [teacherId], references: [id])

  payRunId String?
  payRun   PayRun? @relation("PayRunEntries", fields: [payRunId], references: [id])

  minutesBase       Int
  minutesAdjustment Int   @default(0)
  minutesFinal      Int

  status TimesheetStatus
  source TimesheetSource

  note        String?
  createdById String?
  createdBy   User?   @relation("TimesheetEntryCreator", fields: [createdById], references: [id])

  adjustments TeacherTimesheetAdjustment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, date])
  @@index([teacherId, date])
  @@index([date])
  @@index([payRunId])
  @@index([templateId, date])
}

model TeacherTimesheetAdjustment {
  id String @id @default(cuid())

  entryId String
  entry   TeacherTimesheetEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  minutesDelta Int
  reason       String?

  createdById String?
  createdBy   User?   @relation("TimesheetAdjustmentCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum TimesheetStatus {
  SCHEDULED
  CONFIRMED
  CANCELLED
}

enum TimesheetSource {
  DERIVED
  ATTENDANCE
  MANUAL
}

model ClassCancellation {
  id String @id @default(cuid())

  templateId String
  template   ClassTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // occurrence date (normalize to local midnight)
  date   DateTime
  reason String?

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, date])
  @@index([date])
  @@index([templateId, date])
}

model Attendance {
  id String @id @default(cuid())

  templateId String
  template   ClassTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  date DateTime // normalized to local midnight

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  status AttendanceStatus @default(PRESENT)
  note   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, date, studentId])
  @@index([date])
  @@index([studentId, date])
  @@index([templateId, date])
}

model EnrolmentAdjustment {
  id String @id @default(cuid())

  enrolmentId String
  enrolment   Enrolment @relation(fields: [enrolmentId], references: [id], onDelete: Cascade)

  templateId String
  template   ClassTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  date DateTime // normalized to local midnight

  type EnrolmentAdjustmentType

  creditsDelta         Int?
  paidThroughDeltaDays Int?
  note                 String?

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([enrolmentId, templateId, date, type])
  @@index([templateId, date])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum EnrolmentStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIALLY_PAID
  PAID
  VOID
  OVERDUE
}

enum InvoiceLineItemKind {
  ENROLMENT
  PRODUCT
  DISCOUNT
  ADJUSTMENT
}

enum EnrolmentAdjustmentType {
  CANCELLATION_CREDIT
}

model Enrolment {
  id String @id @default(cuid())

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  templateId String
  template   ClassTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  startDate   DateTime
  endDate     DateTime?
  status      EnrolmentStatus @default(ACTIVE)
  cancelledAt DateTime?

  planId String?
  plan   EnrolmentPlan? @relation(fields: [planId], references: [id])

  paidThroughDate  DateTime?
  creditsRemaining Int?

  adjustments EnrolmentAdjustment[]

  invoices Invoice[]

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  invoiceLineItems InvoiceLineItem[]

  @@index([studentId])
  @@index([templateId])
  @@index([templateId, startDate])
  @@index([templateId, endDate])
}

enum EnrolmentType {
  BLOCK
  CLASS
}

enum BillingType {
  PER_WEEK
  PER_CLASS
  BLOCK
}

model EnrolmentPlan {
  id String @id @default(cuid())

  name       String
  priceCents Int    @default(0)

  enrolmentType   EnrolmentType @default(BLOCK)
  billingType     BillingType   @default(PER_CLASS)
  durationWeeks   Int?
  blockClassCount Int?

  levelId String
  level   Level  @relation(fields: [levelId], references: [id])

  blockLength Int @default(1)

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  enrolments Enrolment[]
}

model Level {
  id String @id @default(cuid())

  name             String
  levelOrder       Int    @default(0)
  defaultLengthMin Int    @default(30)
  defaultCapacity  Int?

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  classTemplates ClassTemplate[]
  enrolmentPlans EnrolmentPlan[]
  students       Student[]
}

model Makeup {
  id String @id @default(cuid())

  originalClassId String?
  newClassId      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Teacher {
  id String @id @default(cuid())

  name     String
  position String?
  phone    String?
  email    String?

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  classTemplates       ClassTemplate[]         @relation("ClassTemplateTeacher")
  teacherSubstitutions TeacherSubstitution[]
  timesheetEntries     TeacherTimesheetEntry[] @relation("TeacherTimesheetEntries")
  payRates             TeacherPayRate[]
  payRunLines          PayRunLine[]
  payrollAdjustments   PayrollAdjustment[]
}

model TeacherPayRate {
  id String @id @default(cuid())

  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id])

  hourlyRateCents Int
  effectiveFrom   DateTime
  effectiveTo     DateTime?

  createdById String?
  createdBy   User?   @relation("TeacherPayRateCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teacherId, effectiveFrom])
  @@unique([teacherId, effectiveFrom])
}

model PayRun {
  id String @id @default(cuid())

  periodStart DateTime
  periodEnd   DateTime
  status      PayRunStatus @default(DRAFT)

  createdById String?
  createdBy   User?   @relation("PayRunCreator", fields: [createdById], references: [id])

  grossCents Int @default(0)

  lines   PayRunLine[]
  entries TeacherTimesheetEntry[] @relation("PayRunEntries")
  payrollAdjustments PayrollAdjustment[] @relation("PayRunAdjustments")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([periodStart, periodEnd])
}

model PayRunLine {
  id String @id @default(cuid())

  payRunId String
  payRun   PayRun @relation(fields: [payRunId], references: [id])

  teacherId String?
  teacher   Teacher? @relation(fields: [teacherId], references: [id])
  staffName String?

  minutesTotal            Int
  grossCents              Int
  hourlyRateCentsSnapshot Int?
  rateBreakdownJson       Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([payRunId, teacherId, staffName])
}

model PayrollAdjustment {
  id String @id @default(cuid())

  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id])

  date         DateTime
  minutesDelta Int
  centsDelta   Int   @default(0)
  reason       String?

  createdById String?
  createdBy   User?   @relation("PayrollAdjustmentCreator", fields: [createdById], references: [id])

  appliedPayRunId String?
  appliedPayRun   PayRun? @relation("PayRunAdjustments", fields: [appliedPayRunId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teacherId, date])
  @@index([appliedPayRunId])
}

enum PayRunStatus {
  DRAFT
  LOCKED
  PAID
  VOID
}

model Product {
  id String @id @default(cuid())

  name       String
  sku        String?
  priceCents Int
  active     Boolean @default(true)

  lineItems InvoiceLineItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sku])
}

model Invoice {
  id String @id @default(cuid())

  familyId String
  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  enrolmentId String?
  enrolment   Enrolment? @relation(fields: [enrolmentId], references: [id], onDelete: Cascade)

  amountCents     Int
  amountPaidCents Int           @default(0)
  status          InvoiceStatus @default(DRAFT)

  coverageStart    DateTime?
  coverageEnd      DateTime?
  creditsPurchased Int?

  issuedAt DateTime  @default(now())
  dueAt    DateTime?
  paidAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  allocations PaymentAllocation[]
  lineItems   InvoiceLineItem[]

  @@index([familyId, status])
  @@index([enrolmentId, status])
  @@index([dueAt])
  @@index([familyId, status, dueAt])
  @@index([issuedAt])
}

model Payment {
  id String @id @default(cuid())

  familyId String
  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  amountCents    Int
  paidAt         DateTime @default(now())
  method         String?
  note           String?
  idempotencyKey String?

  allocations PaymentAllocation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([familyId, idempotencyKey])
  @@index([familyId, paidAt])
  @@index([paidAt])
}

model PaymentAllocation {
  paymentId   String
  invoiceId   String
  amountCents Int

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([paymentId, invoiceId])
  @@index([invoiceId])
}

model InvoicingSweepState {
  id        String   @id
  lastRunAt DateTime
}

model InvoiceLineItem {
  id String @id @default(cuid())

  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId String

  kind           InvoiceLineItemKind
  description    String
  quantity       Int                 @default(1)
  unitPriceCents Int
  amountCents    Int

  product   Product? @relation(fields: [productId], references: [id])
  productId String?

  enrolment   Enrolment? @relation(fields: [enrolmentId], references: [id], onDelete: Cascade)
  enrolmentId String?

  student   Student? @relation(fields: [studentId], references: [id])
  studentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([kind])
  @@index([productId])
  @@index([enrolmentId])
  @@index([studentId])
}

//MESSAGE AND EMAIL RELATED STUFF
enum MessageDirection {
  OUTBOUND
  INBOUND
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

enum MessageChannel {
  SMS
  EMAIL
}

model Conversation {
  id          String  @id @default(cuid())
  phoneNumber String
  familyId    String?
  family      Family? @relation(fields: [familyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]

  @@unique([phoneNumber])
}

model Campaign {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  name        String
  body        String
  createdById String? // admin user
  // derived counters are computed in queries, but you can persist if you want
  messages    Message[]
}

model Message {
  id           String           @id @default(cuid())
  createdAt    DateTime         @default(now())
  direction    MessageDirection
  channel      MessageChannel   @default(SMS)
  body         String
  subject      String?
  fromNumber   String?
  toNumber     String?
  fromEmail    String?
  toEmail      String?
  status       MessageStatus    @default(PENDING)
  providerSid  String?          @unique
  errorCode    String?
  errorMessage String?

  deliveredAt DateTime?
  failedAt    DateTime?

  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id])

  familyId String?
  family   Family? @relation(fields: [familyId], references: [id])

  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])

  @@index([conversationId, createdAt])
  @@index([familyId, createdAt])
  @@index([campaignId, createdAt])
  @@index([status, createdAt])
}

model EmailCampaign {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  createdById String?
  subject     String
  preheader   String?
  html        String
  total       Int
  sent        Int
  failed      Int
  // optional: store filters/segments etc as JSON
  meta        Json?
}
