// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id String @id @default(cuid())

  clerkId String @unique

  familyId String?

  admin Boolean @default(false)

  createdAt                  DateTime              @default(now())
  updatedAt                  DateTime              @updatedAt
  classCancellations         ClassCancellation[]   @relation("ClassCancellationCreator")
  awayPeriodsCreated         AwayPeriod[]          @relation("AwayPeriodCreatedBy")
  enrolmentAdjustments       EnrolmentAdjustment[]
  studentLevelChanges        StudentLevelChange[]  @relation("StudentLevelChangeCreator")
  accountOpeningStates       AccountOpeningState[] @relation("AccountOpeningStateCreator")
  reviewedOnboardingRequests OnboardingRequest[]   @relation("OnboardingReview")
  posSales                   PosSale[]
  waitlistRequests           WaitlistRequest[]
  makeupCreditsCreated       MakeupCredit[]        @relation("MakeupCreditCreatedBy")
}

model Family {
  id String @id @default(cuid())

  name String

  primaryContactName String?
  primaryEmail       String?
  primaryPhone       String?

  secondaryContactName String?
  secondaryEmail       String?
  secondaryPhone       String?

  medicalContactName  String?
  medicalContactPhone String?

  address String?

  students Student[]
  invoices Invoice[]

  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @default(now()) @updatedAt
  payments            Payment[]
  awayPeriods         AwayPeriod[]
  stripePayments      StripePayment[]
  conversations       Conversation[]
  messages            Message[]
  accountOpeningState AccountOpeningState?
  onboardingRequests  OnboardingRequest[]  @relation("OnboardingFamily")
  waitlistRequests    WaitlistRequest[]
  makeupCredits       MakeupCredit[]
  makeupBookings      MakeupBooking[]
}

model AccountOpeningState {
  id String @id @default(cuid())

  familyId String @unique
  family   Family @relation(fields: [familyId], references: [id])

  effectiveDate DateTime

  createdById String
  createdBy   User   @relation("AccountOpeningStateCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  notes     String?
  batchId   String?

  openingBalanceCents Int
}

model Student {
  id String @id @default(cuid())

  name         String
  dateOfBirth  DateTime?
  medicalNotes String?

  family   Family @relation(fields: [familyId], references: [id])
  familyId String

  level   Level?  @relation(fields: [levelId], references: [id])
  levelId String?

  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @default(now()) @updatedAt
  enrolments       Enrolment[]
  awayPeriods      AwayPeriod[]
  attendances      Attendance[]
  invoiceLineItems InvoiceLineItem[]
  levelChanges     StudentLevelChange[]
  waitlistRequests WaitlistRequest[]
  makeupCredits    MakeupCredit[]
  makeupBookings   MakeupBooking[]
}

model ClassTemplate {
  id String @id @default(cuid())

  name      String?
  dayOfWeek Int? //0-6 for Mon to Sun
  startTime Int? //Modelled as minutes since midnight
  endTime   Int? //Modelled as minutes since midnight

  startDate DateTime  @default(now())
  endDate   DateTime?

  capacity Int?
  active   Boolean @default(true)

  levelId String
  level   Level  @relation(fields: [levelId], references: [id])

  teacherId String?
  teacher   Teacher? @relation("ClassTemplateTeacher", fields: [teacherId], references: [id])

  createdAt            DateTime                   @default(now())
  updatedAt            DateTime                   @updatedAt
  enrolments           Enrolment[]
  enrolmentAssignments EnrolmentClassAssignment[]
  teacherSubstitutions TeacherSubstitution[]
  attendances          Attendance[]
  cancellations        ClassCancellation[]
  enrolmentAdjustments EnrolmentAdjustment[]
  holidays             Holiday[]
  waitlistRequests     WaitlistRequest[]
  makeupCreditsEarned  MakeupCredit[]             @relation("MakeupCreditEarnedFromClass")
  makeupBookingsTarget MakeupBooking[]            @relation("MakeupBookingTargetClass")
}

model TeacherSubstitution {
  id String @id @default(cuid())

  templateId String
  template   ClassTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // occurrence date (normalize to local midnight)
  date DateTime

  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id])

  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, date])
  @@index([date])
  @@index([templateId, date])
}

enum OnboardingStatus {
  NEW
  ACCEPTED
  DECLINED
}

enum WaitlistRequestStatus {
  PENDING
  APPROVED
  DECLINED
  CANCELLED
}

model OnboardingRequest {
  id String @id @default(cuid())

  guardianName         String
  phone                String?
  email                String?
  secondaryContactName String?
  secondaryEmail       String?
  secondaryPhone       String?

  emergencyContactName  String?
  emergencyContactPhone String?
  address               String?

  studentsJson     Json
  availabilityJson Json

  updateTokenHash      String?
  updateTokenExpiresAt DateTime?

  status OnboardingStatus @default(NEW)

  familyId String?
  family   Family? @relation("OnboardingFamily", fields: [familyId], references: [id])

  reviewedById String?
  reviewedBy   User?     @relation("OnboardingReview", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([guardianName])
  @@index([email])
  @@index([phone])
}

model WaitlistRequest {
  id String @id @default(cuid())

  familyId String
  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  requestedClassId String
  requestedClass   ClassTemplate @relation(fields: [requestedClassId], references: [id])

  requestedLevelId String?
  requestedLevel   Level?  @relation(fields: [requestedLevelId], references: [id])

  effectiveDate DateTime
  notes         String?

  status     WaitlistRequestStatus @default(PENDING)
  adminNotes String?

  decidedAt       DateTime?
  decidedByUserId String?
  decidedBy       User?     @relation(fields: [decidedByUserId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
  @@index([familyId])
}

model ClassCancellation {
  id String @id @default(cuid())

  templateId String
  template   ClassTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // occurrence date (normalize to local midnight)
  date   DateTime
  reason String?

  createdById String?
  createdBy   User?   @relation("ClassCancellationCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, date])
  @@index([date])
  @@index([templateId, date])
}

model Attendance {
  id String @id @default(cuid())

  templateId String
  template   ClassTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  date DateTime // normalized to local midnight

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  status             AttendanceStatus         @default(PRESENT)
  note               String?
  excusedReason      AttendanceExcusedReason?
  sourceAwayPeriodId String?
  sourceAwayPeriod   AwayPeriod?              @relation("AttendanceAwayPeriod", fields: [sourceAwayPeriodId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creditEvents EnrolmentCreditEvent[]

  @@unique([templateId, date, studentId])
  @@index([date])
  @@index([studentId, date])
  @@index([templateId, date])
  @@index([templateId, date, status])
  @@index([templateId, date, excusedReason])
}

model EnrolmentAdjustment {
  id String @id @default(cuid())

  enrolmentId String
  enrolment   Enrolment @relation(fields: [enrolmentId], references: [id], onDelete: Cascade)

  templateId String
  template   ClassTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  date DateTime // normalized to local midnight

  type EnrolmentAdjustmentType

  creditsDelta         Int?
  paidThroughDeltaDays Int?
  note                 String?

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creditEvents EnrolmentCreditEvent[]

  @@unique([enrolmentId, templateId, date, type])
  @@index([templateId, date])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum AttendanceExcusedReason {
  AWAY_PERIOD
  SICK
  OTHER
}

enum EnrolmentStatus {
  ACTIVE
  PAUSED
  CHANGEOVER
  CANCELLED
}

enum EnrolmentCreditEventType {
  PURCHASE
  CONSUME
  CANCELLATION_CREDIT
  MANUAL_ADJUST
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIALLY_PAID
  PAID
  VOID
  OVERDUE
}

enum InvoiceKind {
  STANDARD
  CATCH_UP
}

enum InvoiceLineItemKind {
  ENROLMENT
  PRODUCT
  DISCOUNT
  ADJUSTMENT
}

enum PaymentStatus {
  COMPLETED
  VOID
}

enum StripePaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
}

enum StripeAccountType {
  STANDARD @map("standard")
}

enum StripeOnboardingStatus {
  NOT_CONNECTED @map("not_connected")
  PENDING       @map("pending")
  CONNECTED     @map("connected")
}

enum EnrolmentAdjustmentType {
  CANCELLATION_CREDIT
}

enum EnrolmentCoverageReason {
  HOLIDAY_ADDED
  HOLIDAY_REMOVED
  HOLIDAY_UPDATED
  CLASS_CHANGED
  PLAN_CHANGED
  INVOICE_APPLIED
  CANCELLATION_CREATED
  CANCELLATION_REVERSED
  PAIDTHROUGH_MANUAL_EDIT
}

model Enrolment {
  id String @id @default(cuid())

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  templateId String
  template   ClassTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  billingGroupId   String?
  isBillingPrimary Boolean @default(true)
  billingPrimaryId String?

  startDate   DateTime
  endDate     DateTime?
  status      EnrolmentStatus @default(ACTIVE)
  cancelledAt DateTime?

  planId String?
  plan   EnrolmentPlan? @relation(fields: [planId], references: [id])

  paidThroughDate         DateTime?
  paidThroughDateComputed DateTime?
  nextDueDateComputed     DateTime?
  creditsRemaining        Int?
  creditsBalanceCached    Int?

  adjustments       EnrolmentAdjustment[]
  awayPeriodImpacts AwayPeriodImpact[]
  classAssignments  EnrolmentClassAssignment[]
  creditEvents      EnrolmentCreditEvent[]
  coverageAudits    EnrolmentCoverageAudit[]

  invoices Invoice[]

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  invoiceLineItems InvoiceLineItem[]

  @@index([studentId])
  @@index([templateId])
  @@index([templateId, startDate])
  @@index([templateId, endDate])
  @@index([billingGroupId])
}

model EnrolmentCoverageAudit {
  id String @id @default(cuid())

  enrolmentId String
  enrolment   Enrolment @relation(fields: [enrolmentId], references: [id], onDelete: Cascade)

  reason                  EnrolmentCoverageReason
  previousPaidThroughDate DateTime?
  nextPaidThroughDate     DateTime?
  actorId                 String?

  createdAt DateTime @default(now())

  @@index([enrolmentId])
  @@index([reason])
  @@index([createdAt])
}

model AwayPeriod {
  id String @id @default(cuid())

  familyId String
  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  studentId String?
  student   Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime
  note      String?

  createdByUserId String?
  createdBy       User?   @relation("AwayPeriodCreatedBy", fields: [createdByUserId], references: [id])

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  impacts           AwayPeriodImpact[]
  attendanceEntries Attendance[]       @relation("AttendanceAwayPeriod")

  @@index([familyId, startDate])
  @@index([familyId, endDate])
  @@index([studentId, startDate])
  @@index([deletedAt])
}

model AwayPeriodImpact {
  id String @id @default(cuid())

  awayPeriodId String
  awayPeriod   AwayPeriod @relation(fields: [awayPeriodId], references: [id], onDelete: Cascade)

  enrolmentId String
  enrolment   Enrolment @relation(fields: [enrolmentId], references: [id], onDelete: Cascade)

  missedOccurrences    Int
  paidThroughDeltaDays Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([awayPeriodId, enrolmentId])
  @@index([enrolmentId])
}

model EnrolmentClassAssignment {
  id String @id @default(cuid())

  enrolmentId String
  enrolment   Enrolment @relation(fields: [enrolmentId], references: [id], onDelete: Cascade)

  templateId String
  template   ClassTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([enrolmentId, templateId])
  @@index([templateId])
}

enum EnrolmentType {
  BLOCK
  CLASS
}

enum BillingType {
  PER_WEEK
  PER_CLASS
}

model EnrolmentPlan {
  id String @id @default(cuid())

  name           String
  priceCents     Int     @default(0)
  isSaturdayOnly Boolean @default(false)

  enrolmentType   EnrolmentType @default(BLOCK)
  billingType     BillingType   @default(PER_CLASS)
  durationWeeks   Int?
  blockClassCount Int?
  sessionsPerWeek Int?

  levelId String
  level   Level  @relation(fields: [levelId], references: [id])

  blockLength Int @default(1)

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  enrolments       Enrolment[]
  invoiceLineItems InvoiceLineItem[]
}

model Holiday {
  id String @id @default(cuid())

  name       String
  startDate  DateTime
  endDate    DateTime
  note       String?
  levelId    String?
  templateId String?

  level    Level?         @relation(fields: [levelId], references: [id])
  template ClassTemplate? @relation(fields: [templateId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([startDate])
  @@index([endDate])
  @@index([levelId])
  @@index([templateId])
}

model Level {
  id String @id @default(cuid())

  name             String
  levelOrder       Int    @default(0)
  defaultLengthMin Int    @default(30)
  defaultCapacity  Int?

  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  classTemplates   ClassTemplate[]
  enrolmentPlans   EnrolmentPlan[]
  students         Student[]
  levelChangesTo   StudentLevelChange[] @relation("StudentLevelChangeTo")
  levelChangesFrom StudentLevelChange[] @relation("StudentLevelChangeFrom")
  holidays         Holiday[]
  waitlistRequests WaitlistRequest[]
  makeupCredits    MakeupCredit[]
}

enum MakeupCreditReason {
  SICK
  OTHER
}

enum MakeupCreditStatus {
  AVAILABLE
  RESERVED
  USED
  CANCELLED
  EXPIRED
}

enum MakeupBookingStatus {
  BOOKED
  CANCELLED
}

model MakeupCredit {
  id String @id @default(cuid())

  familyId String
  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  earnedFromClassId String?
  earnedFromClass   ClassTemplate? @relation("MakeupCreditEarnedFromClass", fields: [earnedFromClassId], references: [id], onDelete: SetNull)

  earnedFromSessionDate DateTime?

  reason MakeupCreditReason

  issuedAt  DateTime           @default(now())
  expiresAt DateTime
  status    MakeupCreditStatus @default(AVAILABLE)

  notes String?

  createdByUserId String?
  createdBy       User?   @relation("MakeupCreditCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  levelId String?
  level   Level?  @relation(fields: [levelId], references: [id], onDelete: SetNull)

  booking MakeupBooking?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, status])
  @@index([familyId, status])
  @@index([expiresAt])
}

model MakeupBooking {
  id String @id @default(cuid())

  makeupCreditId String       @unique
  makeupCredit   MakeupCredit @relation(fields: [makeupCreditId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  familyId String
  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  targetClassId String
  targetClass   ClassTemplate @relation("MakeupBookingTargetClass", fields: [targetClassId], references: [id], onDelete: Cascade)

  targetSessionDate DateTime

  status MakeupBookingStatus @default(BOOKED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([targetClassId, targetSessionDate, studentId])
  @@index([targetClassId, targetSessionDate, status])
  @@index([studentId, status])
  @@index([familyId, status])
}

model Teacher {
  id String @id @default(cuid())

  name     String
  position String?
  phone    String?
  email    String?

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  classTemplates       ClassTemplate[]       @relation("ClassTemplateTeacher")
  teacherSubstitutions TeacherSubstitution[]
}

model Product {
  id String @id @default(cuid())

  name       String
  sku        String?
  barcode    String?
  priceCents Int

  trackInventory    Boolean @default(true)
  stockOnHand       Int     @default(0)
  lowStockThreshold Int?

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  categoryId String
  category   ProductCategory @relation(fields: [categoryId], references: [id])

  lineItems    InvoiceLineItem[]
  posLineItems PosSaleLineItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sku])
  @@unique([barcode])
  @@index([categoryId, sortOrder])
}

model ProductCategory {
  id String @id @default(cuid())

  name      String
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@index([sortOrder])
}

enum PosSaleStatus {
  DRAFT
  COMPLETED
  VOID
}

enum PosPaymentMethod {
  CASH
  CARD
  OTHER
}

model PosSale {
  id     String @id @default(cuid())
  saleNo Int    @unique @default(autoincrement())

  status        PosSaleStatus @default(DRAFT)
  subtotalCents Int
  discountCents Int           @default(0)
  totalCents    Int
  notes         String?

  createdByUserId String
  createdByUser   User   @relation(fields: [createdByUserId], references: [id])

  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  lineItems PosSaleLineItem[]
  payments  PosPayment[]

  @@index([createdAt])
  @@index([status])
}

model PosSaleLineItem {
  id String @id @default(cuid())

  saleId String
  sale   PosSale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  nameSnapshot       String
  priceCentsSnapshot Int
  quantity           Int
  lineTotalCents     Int

  createdAt DateTime @default(now())

  @@index([saleId])
  @@index([productId])
}

model PosPayment {
  id String @id @default(cuid())

  saleId String
  sale   PosSale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  method      PosPaymentMethod
  amountCents Int
  providerRef String?

  createdAt DateTime @default(now())

  @@index([saleId])
}

model Invoice {
  id String @id @default(cuid())

  familyId String
  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  enrolmentId String?
  enrolment   Enrolment? @relation(fields: [enrolmentId], references: [id], onDelete: Cascade)

  amountCents     Int
  amountPaidCents Int           @default(0)
  status          InvoiceStatus @default(DRAFT)
  kind            InvoiceKind   @default(STANDARD)

  coverageStart         DateTime?
  coverageEnd           DateTime?
  creditsPurchased      Int?
  entitlementsAppliedAt DateTime?

  issuedAt DateTime  @default(now())
  dueAt    DateTime?
  paidAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  allocations           PaymentAllocation[]
  lineItems             InvoiceLineItem[]
  enrolmentCreditEvents EnrolmentCreditEvent[]

  @@index([familyId, status])
  @@index([enrolmentId, status])
  @@index([dueAt])
  @@index([familyId, status, dueAt])
  @@index([issuedAt])
}

model Payment {
  id String @id @default(cuid())

  familyId String
  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  amountCents    Int
  paidAt         DateTime      @default(now())
  method         String?
  note           String?
  idempotencyKey String?
  status         PaymentStatus @default(COMPLETED)
  reversedAt     DateTime?
  reversalReason String?

  allocations    PaymentAllocation[]
  stripePayments StripePayment[]     @relation("StripePaymentSettlement")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([familyId, idempotencyKey])
  @@index([familyId, paidAt])
  @@index([paidAt])
  @@index([status])
}

model PaymentAllocation {
  paymentId   String
  invoiceId   String
  amountCents Int

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([paymentId, invoiceId])
  @@index([invoiceId])
}

model StripePayment {
  id String @id @default(cuid())

  familyId String
  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  amountCents Int
  currency    String              @default("usd")
  status      StripePaymentStatus @default(PENDING)

  idempotencyKey        String  @unique
  stripeSessionId       String? @unique
  stripePaymentIntentId String? @unique

  settledPaymentId String?
  settledPayment   Payment? @relation("StripePaymentSettlement", fields: [settledPaymentId], references: [id], onDelete: SetNull)

  metadata Json?

  settledAt   DateTime?
  failedAt    DateTime?
  cancelledAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([familyId, createdAt])
  @@index([familyId, status, createdAt])
}

model ConnectedAccount {
  clientId String @id

  stripeAccountId        String?                @unique
  stripeAccountType      StripeAccountType?
  stripeChargesEnabled   Boolean                @default(false)
  stripePayoutsEnabled   Boolean                @default(false)
  stripeDetailsSubmitted Boolean                @default(false)
  stripeOnboardingStatus StripeOnboardingStatus @default(NOT_CONNECTED)
  stripeLastSyncedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model StripeWebhookEvent {
  id String @id

  type String

  receivedAt DateTime @default(now())
}

model InvoicingSweepState {
  id        String   @id
  lastRunAt DateTime
}

model InvoiceLineItem {
  id String @id @default(cuid())

  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId String

  kind           InvoiceLineItemKind
  description    String
  quantity       Int                 @default(1)
  unitPriceCents Int
  amountCents    Int
  blocksBilled   Int?
  billingType    BillingType?

  product   Product? @relation(fields: [productId], references: [id])
  productId String?

  enrolment   Enrolment? @relation(fields: [enrolmentId], references: [id], onDelete: Cascade)
  enrolmentId String?

  plan   EnrolmentPlan? @relation(fields: [planId], references: [id])
  planId String?

  student   Student? @relation(fields: [studentId], references: [id])
  studentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([kind])
  @@index([productId])
  @@index([enrolmentId])
  @@index([planId])
  @@index([studentId])
}

model EnrolmentCreditEvent {
  id String @id @default(cuid())

  enrolmentId String
  enrolment   Enrolment @relation(fields: [enrolmentId], references: [id], onDelete: Cascade)

  type         EnrolmentCreditEventType
  creditsDelta Int
  occurredOn   DateTime // normalized to local midnight
  note         String?

  invoiceId    String?
  invoice      Invoice?             @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  attendanceId String?
  attendance   Attendance?          @relation(fields: [attendanceId], references: [id], onDelete: SetNull)
  adjustmentId String?
  adjustment   EnrolmentAdjustment? @relation(fields: [adjustmentId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([enrolmentId, occurredOn])
  @@index([occurredOn])
  @@index([invoiceId])
  @@index([attendanceId])
  @@index([adjustmentId])
}

//MESSAGE AND EMAIL RELATED STUFF
enum MessageDirection {
  OUTBOUND
  INBOUND
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

enum MessageChannel {
  SMS
  EMAIL
}

model Conversation {
  id          String  @id @default(cuid())
  phoneNumber String
  familyId    String?
  family      Family? @relation(fields: [familyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]

  @@unique([phoneNumber])
}

model Campaign {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  name        String
  body        String
  createdById String? // admin user
  // derived counters are computed in queries, but you can persist if you want
  messages    Message[]
}

model Message {
  id           String           @id @default(cuid())
  createdAt    DateTime         @default(now())
  direction    MessageDirection
  channel      MessageChannel   @default(SMS)
  body         String
  segments     Int?
  subject      String?
  fromNumber   String?
  toNumber     String?
  fromEmail    String?
  toEmail      String?
  status       MessageStatus    @default(PENDING)
  providerSid  String?          @unique
  errorCode    String?
  errorMessage String?
  unitCost     Decimal?         @db.Decimal(10, 2)
  monthKey     String?          @db.VarChar(7)

  deliveredAt DateTime?
  failedAt    DateTime?

  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id])

  familyId String?
  family   Family? @relation(fields: [familyId], references: [id])

  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])

  @@index([conversationId, createdAt])
  @@index([familyId, createdAt])
  @@index([campaignId, createdAt])
  @@index([status, createdAt])
  @@index([monthKey])
}

model EmailCampaign {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  createdById String?
  subject     String
  preheader   String?
  html        String
  total       Int
  sent        Int
  failed      Int
  // optional: store filters/segments etc as JSON
  meta        Json?
}

model StudentLevelChange {
  id String @id @default(cuid())

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  fromLevelId String?
  fromLevel   Level?  @relation("StudentLevelChangeFrom", fields: [fromLevelId], references: [id])

  toLevelId String
  toLevel   Level  @relation("StudentLevelChangeTo", fields: [toLevelId], references: [id])

  effectiveDate DateTime
  note          String?

  createdById String?
  createdBy   User?   @relation("StudentLevelChangeCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  @@index([studentId])
  @@index([effectiveDate])
}
